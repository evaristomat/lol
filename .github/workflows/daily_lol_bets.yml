name: Daily LOL Bets Automation

on:
  schedule:
    - cron: '0 9 * * *'   # 6:00 AM BrasÃ­lia
    - cron: '0 15 * * *'  # 12:00 PM BrasÃ­lia  
    - cron: '0 21 * * *'  # 6:00 PM BrasÃ­lia
  workflow_dispatch:       # Permite execuÃ§Ã£o manual

jobs:
  run-daily-bets:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      BETSAPI_API_KEY: ${{ secrets.BETSAPI_API_KEY }}
    
    steps:
    # Passo 1: Fazer checkout do cÃ³digo
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: main

    # Passo 2: Configurar Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # Passo 3: Instalar dependÃªncias
    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    # Passo 4: Criar arquivo .env com todas as variÃ¡veis
    - name: Create environment file
      run: |
        echo "BETSAPI_API_KEY=$BETSAPI_API_KEY" > .env
        echo "CACHE_TTL=300" >> .env
        echo "BASE_URL=https://api.betsapi.com/v1" >> .env
        echo "REQUEST_TIMEOUT=30" >> .env
        echo "TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN" >> .env
        echo "TELEGRAM_CHAT_ID=$TELEGRAM_CHAT_ID" >> .env
        echo "âœ… Environment file created"

    # Passo 5: Criar diretÃ³rios necessÃ¡rios
    - name: Create required directories
      run: |
        mkdir -p data
        mkdir -p logs
        mkdir -p reports
        echo "âœ… Directories created"

    # Passo 6: Executar script para obter odds dos prÃ³ximos 10 dias
    - name: Get upcoming odds (10 days)
      run: |
        echo "ðŸ“Š Fetching upcoming odds..."
        cd scripts && python db_get_odds.py
        echo "âœ… Odds retrieved and stored in database"

    # Passo 7: Executar script para atualizar resultados dos Ãºltimos 2 dias
    - name: Get recent match results (2 days)
      run: |
        echo "ðŸ† Fetching recent match results..."
        cd scripts && python db_get_matches.py
        echo "âœ… Match results retrieved and stored in database"

    # Passo 8: Executar script para atualizar resultados de apostas
    - name: Update bet results
      run: |
        echo "ðŸ’° Updating bet results..."
        cd scripts && python db_get_bet_results.py
        echo "âœ… Bet results updated in database"

    # Passo 9: Executar script para verificar novas apostas de valor
    - name: Find value bets
      run: |
        echo "ðŸ” Analyzing value bets..."
        cd scripts && python db_get_bets.py
        echo "âœ… Value bets analysis completed and stored in database"

    # Passo 10: Verificar se hÃ¡ mudanÃ§as nos bancos de dados
    - name: Check for database changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain data/*.db 2>/dev/null)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ Database changes detected"
          git status --porcelain data/*.db
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "ðŸ“ No database changes detected"
        fi

    # Passo 11: Fazer commit e push dos bancos de dados atualizados
    - name: Commit and push updated databases
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        # Configurar Git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Adicionar apenas os arquivos de banco de dados
        git add data/*.db
        
        # Verificar se hÃ¡ mudanÃ§as para commitar
        if git diff --staged --quiet; then
          echo "âš ï¸ No changes to commit after all"
          exit 0
        fi
        
        # Fazer commit
        git commit -m "ðŸ¤– Auto-update databases: $(date +'%Y-%m-%d %H:%M UTC')"
        
        # Sincronizar com o repositÃ³rio remoto
        git fetch origin main
        git rebase origin/main
        
        # Fazer push forÃ§ado para garantir que as alteraÃ§Ãµes sejam aplicadas
        git push origin main
        echo "âœ… Updated databases pushed to repository"

    # Passo 12: Resumo da execuÃ§Ã£o
    - name: Execution Summary
      if: always()
      run: |
        echo "ðŸŽ¯ === EXECUTION SUMMARY ==="
        echo "ðŸ“… Date: $(date +'%Y-%m-%d %H:%M UTC')"
        echo "ðŸ”„ Workflow status: ${{ job.status }}"
        echo "ðŸ’¾ Database files updated:"
        ls -la data/*.db 2>/dev/null || echo "No database files found"
        echo "ðŸ“Š Check repository for updated database files"
        
        # Mostrar Ãºltimos commits para verificaÃ§Ã£o
        echo ""
        echo "ðŸ“œ Last 3 commits:"
        git log --oneline -3