name: Daily LOL Bets Automation

on:
  schedule:
    - cron: '0 9 * * *'   # 6:00 AM BrasÃ­lia
    - cron: '0 15 * * *'  # 12:00 PM BrasÃ­lia  
    - cron: '0 21 * * *'  # 6:00 PM BrasÃ­lia
  workflow_dispatch:       # Permite execuÃ§Ã£o manual

jobs:
  run-daily-bets:
    runs-on: ubuntu-latest
    
    steps:
    # Passo 1: Fazer checkout do cÃ³digo
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: main

    # Passo 2: Configurar Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # Passo 3: Instalar dependÃªncias
    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    # Passo 4: Criar arquivo .env com variÃ¡veis (apenas API_KEY Ã© secreta)
    - name: Create environment file
      env:
        BETSAPI_API_KEY: ${{ secrets.BETSAPI_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "BETSAPI_API_KEY=$BETSAPI_API_KEY" > .env
        echo "CACHE_TTL=300" >> .env
        echo "BASE_URL=https://api.betsapi.com/v1" >> .env
        echo "REQUEST_TIMEOUT=30" >> .env
        echo "âœ… Environment file created"

    # Passo 4.5: Criar diretÃ³rios necessÃ¡rios
    - name: Create required directories
      run: |
        mkdir -p data
        mkdir -p logs
        mkdir -p reports
        echo "âœ… Directories created"

    # Passo 5: Executar script para obter odds dos prÃ³ximos 10 dias
    - name: Get upcoming odds (10 days)
      run: |
        echo "ðŸ“Š Fetching upcoming odds..."
        cd scripts && python db_get_odds.py
        echo "âœ… Odds retrieved and stored in database"

    # Passo 6: Executar script para atualizar resultados dos Ãºltimos 2 dias
    - name: Get recent match results (2 days)
      run: |
        echo "ðŸ† Fetching recent match results..."
        cd scripts && python db_get_matches.py
        echo "âœ… Match results retrieved and stored in database"

    # Passo 7: Executar script para atualizar resultados de apostas
    - name: Update bet results
      run: |
        echo "ðŸ’° Updating bet results..."
        cd scripts && python db_get_bet_results.py
        echo "âœ… Bet results updated in database"

    # Passo 8: Executar script para verificar novas apostas de valor
    - name: Find value bets
      run: |
        echo "ðŸ” Analyzing value bets..."
        cd scripts && python db_get_bets.py
        echo "âœ… Value bets analysis completed and stored in database"

    # Passo 9: Verificar se hÃ¡ mudanÃ§as nos bancos de dados
    - name: Check for database changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain data/*.db 2>/dev/null)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ Database changes detected"
          git status --porcelain data/*.db
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "ðŸ“ No database changes detected"
        fi

    # Passo 10: Fazer commit e push dos bancos de dados atualizados
    - name: Commit and push updated databases
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        # Configurar Git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # IMPORTANTE: Adicionar os arquivos ANTES de fazer pull
        echo "ðŸ“¦ Adding database files to staging..."
        git add data/*.db
        
        # Fazer stash das mudanÃ§as staged para preservÃ¡-las
        echo "ðŸ’¾ Stashing changes..."
        git stash
        
        # Fazer pull das mudanÃ§as remotas
        echo "â¬‡ï¸ Pulling latest changes from remote..."
        git pull --rebase origin main
        
        # Aplicar o stash de volta
        echo "ðŸ“‹ Applying stashed changes..."
        git stash pop || true  # || true para nÃ£o falhar se nÃ£o houver conflitos menores
        
        # Adicionar novamente os arquivos (caso necessÃ¡rio apÃ³s o stash pop)
        git add data/*.db
        
        # Fazer commit
        echo "ðŸ’¬ Creating commit..."
        git commit -m "ðŸ¤– Auto-update databases: $(date +'%Y-%m-%d %H:%M UTC')" || {
          echo "âš ï¸ No changes to commit after merge"
          exit 0
        }
        
        # Fazer push com retry em caso de falha
        echo "â¬†ï¸ Pushing to remote..."
        max_attempts=3
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          if git push origin main; then
            echo "âœ… Updated databases pushed to repository"
            break
          else
            echo "âš ï¸ Push failed (attempt $attempt/$max_attempts)"
            if [ $attempt -lt $max_attempts ]; then
              echo "ðŸ”„ Pulling latest changes and retrying..."
              git pull --rebase origin main
              attempt=$((attempt + 1))
              sleep 2
            else
              echo "âŒ Failed to push after $max_attempts attempts"
              exit 1
            fi
          fi
        done

    # Passo 11: Resumo da execuÃ§Ã£o
    - name: Execution Summary
      if: always()
      run: |
        echo "ðŸŽ¯ === EXECUTION SUMMARY ==="
        echo "ðŸ“… Date: $(date +'%Y-%m-%d %H:%M UTC')"
        echo "ðŸ”„ Workflow status: ${{ job.status }}"
        echo "ðŸ’¾ Database files updated:"
        ls -la data/*.db 2>/dev/null || echo "No database files found"
        echo "ðŸ“Š Check repository for updated database files"
        
        # Mostrar Ãºltimos commits para verificaÃ§Ã£o
        echo ""
        echo "ðŸ“œ Last 3 commits:"
        git log --oneline -3