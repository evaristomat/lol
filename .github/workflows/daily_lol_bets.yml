name: Daily LOL Bets Automation

on:
  schedule:
    - cron: '0 9 * * *'   # 6:00 AM BrasÃ­lia
    - cron: '0 15 * * *'  # 12:00 PM BrasÃ­lia  
    - cron: '0 21 * * *'  # 6:00 PM BrasÃ­lia
  workflow_dispatch:       # Permite execuÃ§Ã£o manual

jobs:
  run-daily-bets:
    runs-on: ubuntu-latest
    
    steps:
    # Passo 1: Fazer checkout do cÃ³digo
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: main

    # Passo 2: Configurar Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # Passo 3: Instalar dependÃªncias
    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    # Passo 4: Criar arquivo .env com variÃ¡veis (apenas API_KEY Ã© secreta)
    - name: Create environment file
      env:
        BETSAPI_API_KEY: ${{ secrets.BETSAPI_API_KEY }}
      run: |
        echo "BETSAPI_API_KEY=$BETSAPI_API_KEY" > .env
        echo "CACHE_TTL=300" >> .env
        echo "BASE_URL=https://api.betsapi.com/v1" >> .env
        echo "REQUEST_TIMEOUT=30" >> .env
        echo "âœ… Environment file created"

    # Passo 4.5: Criar diretÃ³rios necessÃ¡rios
    - name: Create required directories
      run: |
        mkdir -p data
        mkdir -p logs
        mkdir -p reports
        echo "âœ… Directories created"

    # Passo 5: Executar script para obter odds dos prÃ³ximos 10 dias
    - name: Get upcoming odds (10 days)
      run: |
        echo "ğŸ“Š Fetching upcoming odds..."
        cd scripts && python db_get_odds.py
        echo "âœ… Odds retrieved and stored in database"

    # Passo 6: Executar script para atualizar resultados dos Ãºltimos 2 dias
    - name: Get recent match results (2 days)
      run: |
        echo "ğŸ† Fetching recent match results..."
        cd scripts && python db_get_matches.py
        echo "âœ… Match results retrieved and stored in database"

    # Passo 7: Executar script para atualizar resultados de apostas
    - name: Update bet results
      run: |
        echo "ğŸ’° Updating bet results..."
        cd scripts && python db_get_bet_results.py
        echo "âœ… Bet results updated in database"

    # Passo 8: Executar script para verificar novas apostas de valor
    - name: Find value bets
      run: |
        echo "ğŸ” Analyzing value bets..."
        cd scripts && python db_get_bets.py
        echo "âœ… Value bets analysis completed and stored in database"

    # Passo 9: Verificar se hÃ¡ mudanÃ§as nos bancos de dados
    - name: Check for database changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain data/*.db 2>/dev/null)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ Database changes detected"
          git status --porcelain data/*.db
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "ğŸ“ No database changes detected"
        fi

    # Passo 10: Fazer commit e push dos bancos de dados atualizados
            
    - name: Commit and push updated databases
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Fazer pull com rebase para integrar mudanÃ§as remotas
        git pull --rebase origin main
        
        # Adicionar apenas os bancos de dados modificados
        git add data/*.db
        
        # Fazer commit
        git commit -m "ğŸ¤– Auto-update databases: $(date +'%Y-%m-%d %H:%M UTC')"
        
        # Fazer push
        git push origin main
        echo "âœ… Updated databases pushed to repository"

    # Passo 11: Resumo da execuÃ§Ã£o
    - name: Execution Summary
      if: always()
      run: |
        echo "ğŸ¯ === EXECUTION SUMMARY ==="
        echo "ğŸ“… Date: $(date +'%Y-%m-%d %H:%M UTC')"
        echo "ğŸ”„ Workflow completed successfully"
        echo "ğŸ’¾ Database files updated:"
        ls -la data/*.db 2>/dev/null || echo "No database files found"
        echo "ğŸ“Š Check repository for updated database files"